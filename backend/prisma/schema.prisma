generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id        String   @id @default(uuid())
  name      String
  type      OrgType
  createdAt DateTime @default(now())
  College   College?
  tests     Test[]
  users     User[]
}

model User {
  id           String        @id @default(uuid())
  email        String        @unique
  password     String
  role         UserRole
  orgId        String?
  branchId     String?
  createdAt    DateTime      @default(now())
  students     Student?
  testsCreated Test[]
  organization Organization? @relation(fields: [orgId], references: [id])
}

model College {
  id            String       @id @default(uuid())
  orgId         String       @unique
  collegeName   String
  collegeType   CollegeType
  address       String
  contactPerson String
  contactEmail  String
  mobile        String
  maxStudents   Int
  isApproved    Boolean      @default(false)
  createdAt     DateTime     @default(now())
  Organization  Organization @relation(fields: [orgId], references: [id])
  departments   Department[]
  students      Student[]

  @@index([orgId])
}

model Department {
  id        String    @id @default(uuid())
  name      String
  collegeId String
  createdAt DateTime  @default(now())
  college   College   @relation(fields: [collegeId], references: [id])
  students  Student[]

  @@unique([name, collegeId])
  @@index([collegeId])
}

model Student {
  id           String       @id @default(uuid())
  rollNo       String
  year         Int
  userId       String       @unique
  collegeId    String
  departmentId String
  createdAt    DateTime     @default(now())
  college      College      @relation(fields: [collegeId], references: [id])
  department   Department   @relation(fields: [departmentId], references: [id])
  user         User         @relation(fields: [userId], references: [id])
  submissions  Submission[]

  @@unique([rollNo, collegeId])
  @@index([collegeId])
  @@index([departmentId])
}

model Test {
  id          String     @id @default(uuid())
  name        String
  description String?
  type        TestType
  duration    Int // in minutes
  status      TestStatus @default(DRAFT)

  // Flags
  showResultImmediately Boolean @default(false)
  proctoringEnabled     Boolean @default(false)

  // JSON configs (flexible)
  eligibilityCriteria Json?
  proctoringConfig    Json?

  // Relations
  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  sections    TestSection[]
  questions   Question[]
  submissions Submission[]

  createdAt DateTime @default(now())
}

model TestSection {
  id        String     @id @default(uuid())
  name      String
  timeLimit Int // minutes

  testId    String
  test      Test       @relation(fields: [testId], references: [id])
  questions Question[]
  createdAt DateTime   @default(now())
}

model Question {
  id String @id @default(uuid())

  testId    String
  sectionId String?

  type       QuestionType
  difficulty DifficultyLevel

  title       String
  description String?

  options          Json? // MCQ options
  correctAnswer    Json? // MCQ / Aptitude answers
  evaluationConfig Json? // Coding test cases, constraints

  marks        Int
  timeLimitSec Int?

  order Int

  explanation String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  test              Test               @relation(fields: [testId], references: [id])
  section           TestSection?       @relation(fields: [sectionId], references: [id])
  submissionAnswers SubmissionAnswer[]

  @@index([testId])
  @@index([sectionId])
}

model Submission {
  id          String           @id @default(uuid())
  studentId   String
  testId      String
  status      SubmissionStatus @default(IN_PROGRESS)
  score       Int              @default(0)
  startedAt   DateTime         @default(now())
  submittedAt DateTime?
  evaluatedAt DateTime?

  student Student            @relation(fields: [studentId], references: [id])
  test    Test               @relation(fields: [testId], references: [id])
  answers SubmissionAnswer[]

  @@unique([studentId, testId]) // Prevent multiple attempts (optional)
  @@index([studentId])
  @@index([testId])
}

model SubmissionAnswer {
  id             String   @id @default(uuid())
  submissionId   String
  questionId     String
  selectedAnswer String?
  isCorrect      Boolean?
  marksObtained  Int      @default(0)

  submission Submission @relation(fields: [submissionId], references: [id])
  question   Question   @relation(fields: [questionId], references: [id])

  @@unique([submissionId, questionId])
}

enum OrgType {
  COLLEGE
  COMPANY
}

enum UserRole {
  SUPER_ADMIN
  COLLEGE_ADMIN
  COMPANY_ADMIN
  STUDENT
}

enum CollegeType {
  ENGINEERING
  DEGREE
  POLYTECHNIC
  OTHER
}

enum TestType {
  APTITUDE
  CODING
  MIXED
}

enum TestStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum QuestionType {
  MCQ
  CODING
  APTITUDE
}

enum DifficultyLevel {
  EASY
  MEDIUM
  HARD
}

enum SubmissionStatus {
  IN_PROGRESS
  SUBMITTED
  EVALUATED
}
