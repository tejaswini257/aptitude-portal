generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id        String    @id @default(uuid())
  name      String    @unique
  type      OrgType
  createdAt DateTime  @default(now())
  college   College[]
  users     User[]
  tests     Test[]
}

model User {
  id           String        @id @default(uuid())
  email        String        @unique
  password     String
  role         UserRole
  orgId        String?
  branchId     String?
  createdAt    DateTime      @default(now())
  students     Student?
  organization Organization? @relation(fields: [orgId], references: [id])
  tests        Test[]
}

model College {
  id            String       @id @default(uuid())
  orgId         String       @unique
  collegeName   String
  collegeType   CollegeType
  address       String
  contactPerson String
  contactEmail  String
  mobile        String
  maxStudents   Int
  isApproved    Boolean      @default(false)
  createdAt     DateTime     @default(now())
  organization  Organization @relation(fields: [orgId], references: [id])
  departments   Department[]
  students      Student[]

  @@index([orgId])
}

model Department {
  id        String    @id @default(uuid())
  name      String
  collegeId String
  createdAt DateTime  @default(now())
  college   College   @relation(fields: [collegeId], references: [id])
  students  Student[]

  @@unique([name, collegeId])
  @@index([collegeId])
}

model Student {
  id           String     @id @default(uuid())
  rollNo       String
  year         Int
  userId       String     @unique
  collegeId    String
  departmentId String
  createdAt    DateTime   @default(now())
  college      College    @relation(fields: [collegeId], references: [id])
  department   Department @relation(fields: [departmentId], references: [id])
  user         User       @relation(fields: [userId], references: [id])

  @@unique([rollNo, collegeId])
  @@index([collegeId])
  @@index([departmentId])
}

model Test {
  id          String     @id @default(uuid())
  name        String
  description String?
  type        TestType
  duration    Int // in minutes
  status      TestStatus @default(DRAFT)

  // Flags
  showResultImmediately Boolean @default(false)
  proctoringEnabled     Boolean @default(false)

  // JSON configs (flexible)
  eligibilityCriteria Json?
  proctoringConfig    Json?

  // Relations
  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  sections TestSection[]

  createdAt DateTime @default(now())
}

model TestSection {
  id        String @id @default(uuid())
  name      String
  timeLimit Int // minutes

  testId String
  test   Test   @relation(fields: [testId], references: [id])

  createdAt DateTime @default(now())
}

enum OrgType {
  COLLEGE
  COMPANY
}

enum UserRole {
  SUPER_ADMIN
  COLLEGE_ADMIN
  COMPANY_ADMIN
  STUDENT
}

enum CollegeType {
  ENGINEERING
  DEGREE
  POLYTECHNIC
  OTHER
}

enum TestType {
  APTITUDE
  CODING
  MIXED
}

enum TestStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}
